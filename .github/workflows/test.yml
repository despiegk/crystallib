name: Release Hero

permissions:
  contents: write

on:
  push:

jobs:
  build-publish:
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref_name }} and your repository is ${{ github.repository }}."
      - run: |
          set -x
          mkdir -p ${{ github.workspace }}/hero/
          echo 'test' > ${{ github.workspace }}/hero/toupload_${{ matrix.os }}.txt
          find  ~/hero
          echo ~/hero"
      - name: upload hero
        uses: actions/upload-artifact@v3
        with:
          name: hero_${{ matrix.os }}.zip
          path: ${{ github.workspace }}/hero/toupload_${{ matrix.os }}.txt
          if-no-files-found: err
          compression-level: 6
          
      # - name: Install dependencies
      #   run: |
      #     if [ ${{ matrix.os }} == 'ubuntu-latest' ]; then
      #       sudo apt install -y libgc-dev tmux git rsync curl imagemagick redis   
      #       sudo systemctl start redis         
      #     else
      #       brew install libgc tmux git rsync curl redis libpq
      #       brew services start redis
      #     fi          
      #     sleep 2
      #     redis-cli ping  

      # - name: Setup Vlang
      #   uses: vlang/setup-v@v1.3
      #   with:
      #     check-latest: true

      # - name: Check out repository code
      #   uses: actions/checkout@v3

      # - name: Checkout another repository
      #   uses: actions/checkout@v3
      #   with:
      #     repository: freeflowuniverse/webcomponents
      #     path: webcomponents

      # - name: Install crystallib
      #   run: |
      #     mkdir -p ~/.vmodules/freeflowuniverse
      #     rm -f ~/.vmodules/freeflowuniverse/crystallib
      #     ln -s $(pwd)/crystallib ~/.vmodules/freeflowuniverse/crystallib
      #     rm -f ~/.vmodules/freeflowuniverse/webcomponents
      #     ln -s $(pwd)/webcomponents/webcomponents ~/.vmodules/freeflowuniverse/webcomponents    

      # - name: Build hero
      #   run: |
      #     pushd cli/hero
      #     v -enable-globals -w hero.v
      #     chmod +x hero
      #     mv hero hero_${{ matrix.os }}
      #     find $(pwd)
      #     popd

      # - name: Extract tag name
      #   run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
      
      - uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: 'latest'
          tag: '0.9.7'
          draft: true
          prerelease: false
          commit: 'development'
          allowUpdates: true          
          artifacts: "hero*"
